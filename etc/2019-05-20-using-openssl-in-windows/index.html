<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><title class="next-head">Windows에서 openssl로 인증서 생성하고 MQTT로 테스트하기</title><meta name="description" content="회사에서 MQTT를 SSL/TLS로 테스트해야 하는 경우가 생겼는데, 기존에 나와있는 Eclipse Mosquitto로 하려다가 이왕 하는 김에
Javascrpt로 MQTT Broker랑 Client (Pub, Sub)를 직접 구현해보기로 했다.

전체적으로 MQTT Broker와 Client를 구현하기 위한 라이브러리들은 다음과 같다.

 * Mosca ..." class="next-head"/><meta name="keywords" content="openssl, typescript, mqtt" class="next-head"/><meta property="og:title" content="Windows에서 openssl로 인증서 생성하고 MQTT로 테스트하기" class="next-head"/><meta property="og:description" content="회사에서 MQTT를 SSL/TLS로 테스트해야 하는 경우가 생겼는데, 기존에 나와있는 Eclipse Mosquitto로 하려다가 이왕 하는 김에
Javascrpt로 MQTT Broker랑 Client (Pub, Sub)를 직접 구현해보기로 했다.

전체적으로 MQTT Broker와 Client를 구현하기 위한 라이브러리들은 다음과 같다.

 * Mosca ..." class="next-head"/><meta property="og:type" content="website" class="next-head"/><meta property="og:site_name" content="Dev.log" class="next-head"/><meta property="og:locale" content="ko_KR" class="next-head"/><meta property="og:url" content="https://salgum1114.github.io/etc/2019-05-20-using-openssl-in-windows" class="next-head"/><meta property="og:image" content="https://salgum1114.github.io/static/images/covers/openssl.png" class="next-head"/><meta name="twitter:title" content="Windows에서 openssl로 인증서 생성하고 MQTT로 테스트하기" class="next-head"/><meta name="twitter:image" content="https://salgum1114.github.io/static/images/covers/openssl.png" class="next-head"/><link rel="preload" href="/_next/static/U5IhnviFqTk~~epRaNeLM/pages/post.js" as="script"/><link rel="preload" href="/_next/static/U5IhnviFqTk~~epRaNeLM/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/U5IhnviFqTk~~epRaNeLM/pages/_error.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-23e8ad5be623829fec40.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.e3402e7f824d0aba2cfe.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.7ace514dc30ea1c400cd.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-8874558eaa942f1ad073.js" as="script"/><link rel="stylesheet" href="/_next/static/css/commons.d4e59d22.chunk.css"/><link rel="stylesheet" href="/_next/static/css/styles.70e7ce38.chunk.css"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/><meta name="google-site-verification" content="YCCU8qpDKf7ka8WDDPA6rt1y0m9egFSi7zeHgmayb6Y"/><meta name="description" content="salgum1114 Dev.log"/><meta name="keywords" content="salgum1114,blog,react,antd,webpack,css,javascript"/><meta property="og:title" content="Dev.log"/><meta property="og:description" content="salgum1114 Dev.log"/><meta property="og:type" content="website"/><meta property="og:site_name" content="Dev.log"/><meta property="og:locale" content="ko_KR"/><meta property="og:url" content="https://salgum1114.github.io"/><meta property="og:image" content="https://salgum1114.github.io/static/images/authors/salgum1114.png"/><meta name="twitter:title" content="Dev.log"/><meta name="twitter:image" content="https://salgum1114.github.io/static/images/authors/salgum1114.png"/><link rel="manifest" href="/static/manifest.json"/><link rel="icon" type="image/png" sizes="192x192" href="/static/images/favicon/icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/static/images/favicon/favicon-96x96.png"/><link rel="shortcut icon" href="/static/favicon.ico"/><link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/notosanskr.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/railscasts.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-97485289-2"></script><script>
                        window.dataLayer = window.dataLayer || [];
                        function gtag() {
                            dataLayer.push(arguments);
                        }
                        gtag('js', new Date());
                        gtag('config', 'UA-97485289-2');
                    </script><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="__next"><section class="ant-layout" style="height:100%"><header class="ant-layout-header" style="background-color:#fff;padding:0;box-shadow:0px 0px 10px -2px rgba(0, 0, 0, 0.75);z-index:1000"><div style="display:flex;align-items:center;height:100%"><div style="display:flex;justify-content:flex-start;margin-left:16px;cursor:pointer"><i aria-label="icon: bars" style="font-size:1.25rem" tabindex="-1" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" class="" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i></div><div style="display:flex;justify-content:center;flex:1;color:#000;font-weight:500;overflow:hidden"><h2 class="container-title"></h2><a href="https://github.com/salgum1114" target="_blank"><i aria-label="icon: github" style="font-size:1.25rem" class="anticon anticon-github"><svg viewBox="64 64 896 896" class="" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></div><div style="display:flex;justify-content:flex-end;align-items:center;margin-right:16px"><i aria-label="icon: search" style="font-size:1.25rem" tabindex="-1" class="anticon anticon-search"><svg viewBox="64 64 896 896" class="" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></i></div></div></header><main class="ant-layout-content" style="overflow:auto"><div class="container" style="display:flex;justify-content:center"><div style="overflow-x:hidden;margin:auto;max-width:992px;flex:1;width:inherit"><div style="-webkit-flex-direction:row;flex-direction:row;-webkit-transition:all 0s ease 0s;transition:all 0s ease 0s;direction:ltr;display:flex;will-change:transform" class="react-swipeable-view-container"><div style="width:100%;-webkit-flex-shrink:0;flex-shrink:0;overflow:auto" aria-hidden="false" data-swipeable="true"><div style="margin:auto;max-width:992px;flex:1;width:inherit"><div class="post-header" style="background-size:cover;background-position:center;height:20rem;margin-bottom:2rem;background-image:url(/static/images/covers/openssl.png)"><div style="background-color:rgba(0, 0, 0, 0.5);display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%"><h1 class="post-title" style="font-size:2.5em;text-align:center;margin-bottom:2rem;line-height:3.2rem;word-break:break-word;color:#fff">Windows에서 openssl로 인증서 생성하고 MQTT로 테스트하기</h1><div style="font-size:1.125em;color:#ffffffc2"><span style="margin-right:8px">2019.05.20</span><span>(3일 전)</span></div></div></div><div class="blog-markdown"><div class="markdown-body"><p>회사에서 MQTT를 SSL/TLS로 테스트해야 하는 경우가 생겼는데, 기존에 나와있는 <a href="https://mosquitto.org/">Eclipse Mosquitto</a>로 하려다가 이왕 하는 김에 Javascrpt로 MQTT Broker랑 Client (Pub, Sub)를 직접 구현해보기로 했다.</p>
<p>전체적으로 MQTT Broker와 Client를 구현하기 위한 라이브러리들은 다음과 같다.</p>
<ul>
<li><a href="https://github.com/mcollina/mosca">Mosca</a> (MQTT Broker) </li>
<li><a href="https://github.com/mqttjs/MQTT.js">MQTT.js</a> (MQTT Client)</li>
</ul>
<p>두개의 라이브러리를 받고 예제를 각 라이브러리들의 github에서 사용법을 찾아보면 된다.</p>
<h2 id="moscaserverts">Mosca 예제 (server.ts)</h2>
<pre><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> mosca <span class="hljs-keyword">from</span> <span class="hljs-string">'mosca'</span>;

<span class="hljs-keyword">import</span> { moscaSettings } <span class="hljs-keyword">from</span> <span class="hljs-string">'./options'</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> mosca.Server(moscaSettings, () =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Mosca server is up and running'</span>);
});

server.on(<span class="hljs-string">'clientConnected'</span>, (client: mosca.Client) =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Client connected'</span>, client.id, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());
});

server.on(<span class="hljs-string">'clientDisconnected'</span>, (client: mosca.Client) =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Client Disconnected:'</span>, client.id, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>());
});

server.on(<span class="hljs-string">'published'</span>, (packet: mosca.Packet, client?: mosca.Client, callback?: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">void</span>) =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Published'</span>, packet.payload, client &amp;&amp; client.id, callback);
});
</code></pre>
<h2 id="mqttjspublisherts">MQTT.js 예제 (publisher.ts)</h2>
<pre><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> mqtt <span class="hljs-keyword">from</span> <span class="hljs-string">'mqtt'</span>;

<span class="hljs-keyword">import</span> { mqttClientOptions, mqttsClientOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">'./options'</span>;

<span class="hljs-keyword">const</span> client = mqtt.connect(mqttsClientOptions);

client.on(<span class="hljs-string">'connect'</span>, () =&gt; {
    client.subscribe(<span class="hljs-string">'presence'</span>);
    client.publish(<span class="hljs-string">'presence'</span>, <span class="hljs-string">'Hello mqtt'</span>);
    client.end();
});

client.on(<span class="hljs-string">'error'</span>, (error) =&gt; {
    <span class="hljs-built_in">console</span>.log(error);
});
</code></pre>
<h2 id="mqttjssubsriberts">MQTT.js 예제 (subsriber.ts)</h2>
<pre><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> mqtt <span class="hljs-keyword">from</span> <span class="hljs-string">'mqtt'</span>;

<span class="hljs-keyword">import</span> { mqttClientOptions, mqttsClientOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">'./options'</span>;

<span class="hljs-keyword">const</span> client = mqtt.connect(mqttsClientOptions);

client.on(<span class="hljs-string">'connect'</span>, () =&gt; {
    client.subscribe(<span class="hljs-string">'presence'</span>);
});

client.on(<span class="hljs-string">'message'</span>, (topic, message) =&gt; {
    <span class="hljs-built_in">console</span>.log(topic, message);
    client.end();
});

client.on(<span class="hljs-string">'error'</span>, (error) =&gt; {
    <span class="hljs-built_in">console</span>.log(error);
});
</code></pre>
<h2 id="optionsts">옵션 (options.ts)</h2>
<pre><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> { IClientOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">'mqtt'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-keyword">export</span> interface ClientOptions extends IClientOptions {
    passphrase?: string;
    secureProtocol?: string;
}

<span class="hljs-keyword">export</span> interface MoscaLogger {
    name?: string;
    level?: number | string;
}

<span class="hljs-keyword">export</span> interface MoscaSecure {
    port?: number;
    keyPath?: string;
    certPath?: string;
}

<span class="hljs-keyword">export</span> interface MoscaSettings {
    <span class="hljs-attr">port</span>: number;
    logger?: MoscaLogger;
    secure?: MoscaSecure;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mqttClientOptions: ClientOptions = {
    <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">1883</span>,
    <span class="hljs-attr">protocol</span>: <span class="hljs-string">'mqtt'</span>,
    <span class="hljs-attr">connectTimeout</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mqttsClientOptions: ClientOptions = {
    <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">8443</span>,
    <span class="hljs-attr">protocol</span>: <span class="hljs-string">'mqtts'</span>,
    <span class="hljs-attr">protocolId</span>: <span class="hljs-string">'MQIsdp'</span>,
    <span class="hljs-attr">protocolVersion</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">secureProtocol</span>: <span class="hljs-string">'TLSv1_method'</span>,
    <span class="hljs-attr">reconnectPeriod</span>: <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>,
    <span class="hljs-attr">rejectUnauthorized</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">connectTimeout</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>,
    <span class="hljs-attr">ca</span>: [fs.readFileSync(<span class="hljs-string">'keystore/ca/ca.crt'</span>)],
    <span class="hljs-attr">key</span>: fs.readFileSync(<span class="hljs-string">'keystore/client/client.key'</span>),
    <span class="hljs-attr">cert</span>: fs.readFileSync(<span class="hljs-string">'keystore/client/client.crt'</span>),
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> moscaSettings: MoscaSettings = {
    <span class="hljs-attr">port</span>: <span class="hljs-number">1883</span>,
    <span class="hljs-attr">logger</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"secure"</span>,
        <span class="hljs-attr">level</span>: <span class="hljs-number">40</span>,
    },
    <span class="hljs-attr">secure</span>: {
        <span class="hljs-attr">port</span>: <span class="hljs-number">8443</span>,
        <span class="hljs-attr">keyPath</span>: <span class="hljs-string">'keystore/server/server.key'</span>,
        <span class="hljs-attr">certPath</span>: <span class="hljs-string">'keystore/server/server.crt'</span>,
    },
};
</code></pre>
<p>이제 문제는 Openssl 인데, Windows에서 Openssl을 사용하기 위해 2가지 방법이 있다.</p>
<ol>
<li>바이너리로 묵인 것을 다운로드 받기.</li>
<li>소스를 받아서 직접 빌드하기.</li>
</ol>
<p>2번은 귀찮기 때문에, 1번을 찾아보고 다운로드 받았다.</p>
<blockquote>
  <p><a href="https://code.google.com/archive/p/openssl-for-windows/downloads">https://code.google.com/archive/p/openssl-for-windows/downloads</a></p>
</blockquote>
<p>다운로드 받고나면 압축을 푼 경로로 들어가 <code>bin</code>에서 <code>Windows Command Line</code>으로 직접 <code>openssl</code>명령어를 치면 되지만, 매번 할 수 없기 때문에 이것도 javascript로 <code>keygen</code>을 만들었다.</p>
<p>프로젝트 경로로 맞춰 명령어를 실행하기 위해 openssl을 압축을 풀어 프로젝트 내부로 옮기고, 마찬가지로 openssl로 생성된 키와 인증서를 프로젝트 내부에 두기 위해 프로젝트 내에 <code>keystore</code> 폴더를 만든다.</p>
<blockquote>
  <p>Openssl로 생성해야되는 키와 인증서는 자체 서명된 CA, Server, Client가 모두 필요하기 때문에 keystore 하위 폴더로 ca, server, client를 만든다.</p>
</blockquote>
<p>위에 작성된 MQTT Broker, Client, Options를 포함하여 이렇게 생긴 폴더 구조가 생길 것이다.</p>
<p><img src="/static/images/etc/openssl-project-directory.png" alt="project-directory" /></p>
<p>그 다음 openssl 명령어를 실행하기 위한 Keygen을 작성한다.</p>
<h2 id="keygenkeygents">Keygen (keygen.ts)</h2>
<pre><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> { execSync, ExecSyncOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">'child_process'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

type Status = <span class="hljs-string">'all'</span> | <span class="hljs-string">'ca'</span> | <span class="hljs-string">'server'</span> | <span class="hljs-string">'client'</span> | <span class="hljs-string">'verify'</span>;

<span class="hljs-keyword">const</span> argsLength = process.argv.length;
<span class="hljs-keyword">let</span> status: Status = <span class="hljs-string">'all'</span>;
<span class="hljs-keyword">if</span> (argsLength &gt; <span class="hljs-number">2</span>) {
    status = process.argv.slice(<span class="hljs-number">2</span>)[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> Status;
}

<span class="hljs-keyword">const</span> opensslPath = <span class="hljs-string">'openssl/bin/openssl'</span>;
<span class="hljs-keyword">const</span> opensslConfPath = <span class="hljs-string">`openssl/openssl.cnf`</span>;
<span class="hljs-keyword">const</span> binPath = path.resolve(__dirname, opensslPath)
<span class="hljs-keyword">const</span> confPath = path.resolve(__dirname, opensslConfPath);
<span class="hljs-keyword">const</span> execSyncOption: ExecSyncOptions = {
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">'inherit'</span>,
}

<span class="hljs-comment">/**
 * Create CA
 */</span>
<span class="hljs-keyword">const</span> caKeystorePath = <span class="hljs-string">'keystore/ca'</span>;
<span class="hljs-keyword">const</span> caKeyPath = <span class="hljs-string">`<span class="hljs-subst">${caKeystorePath}</span>/ca.key`</span>;
<span class="hljs-keyword">const</span> caCrtPath = <span class="hljs-string">`<span class="hljs-subst">${caKeystorePath}</span>/ca.crt`</span>;
<span class="hljs-keyword">if</span> (status === <span class="hljs-string">'all'</span> || status === <span class="hljs-string">'ca'</span>) {
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> req -new -x509 -days 1024 -extensions v3_ca -keyout <span class="hljs-subst">${caKeyPath}</span> -out <span class="hljs-subst">${caCrtPath}</span> -config <span class="hljs-subst">${confPath}</span>`</span>, execSyncOption);
}

<span class="hljs-keyword">if</span> (status === <span class="hljs-string">'verify'</span>) {
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> x509 -text -in <span class="hljs-subst">${caCrtPath}</span>`</span>, execSyncOption)   ;
}

<span class="hljs-comment">/**
 * Create server key
 */</span>
<span class="hljs-keyword">const</span> serverKeystorePath = <span class="hljs-string">'keystore/server'</span>;
<span class="hljs-keyword">const</span> serverKeyPath = <span class="hljs-string">`<span class="hljs-subst">${serverKeystorePath}</span>/server.key`</span>;
<span class="hljs-keyword">const</span> serverCsrPath =  <span class="hljs-string">`<span class="hljs-subst">${serverKeystorePath}</span>/server.csr`</span>;
<span class="hljs-keyword">const</span> serverCrtPath = <span class="hljs-string">`<span class="hljs-subst">${serverKeystorePath}</span>/server.crt`</span>;
<span class="hljs-keyword">if</span> (status === <span class="hljs-string">'all'</span> || status === <span class="hljs-string">'server'</span>) {
    <span class="hljs-comment">// execSync(`${binPath} genrsa -des3 -out ${serverKeyPath} 2048`, execSyncOption);</span>
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> genrsa -out <span class="hljs-subst">${serverKeyPath}</span> 2048`</span>, execSyncOption);
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> req -out <span class="hljs-subst">${serverCsrPath}</span> -key <span class="hljs-subst">${serverKeyPath}</span> -new -config <span class="hljs-subst">${confPath}</span>`</span>, execSyncOption);
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> x509 -req -in <span class="hljs-subst">${serverCsrPath}</span> -CA <span class="hljs-subst">${caCrtPath}</span> -CAkey <span class="hljs-subst">${caKeyPath}</span> -CAcreateserial -out <span class="hljs-subst">${serverCrtPath}</span> -days 1024`</span>, execSyncOption);
}

<span class="hljs-comment">/**
 * Create client key
 */</span>
<span class="hljs-keyword">const</span> clientKeystorePath = <span class="hljs-string">'keystore/client'</span>;
<span class="hljs-keyword">const</span> clientKeyPath = <span class="hljs-string">`<span class="hljs-subst">${clientKeystorePath}</span>/client.key`</span>;
<span class="hljs-keyword">const</span> clientCsrPath = <span class="hljs-string">`<span class="hljs-subst">${clientKeystorePath}</span>/client.csr`</span>;
<span class="hljs-keyword">const</span> clientCrtPath = <span class="hljs-string">`<span class="hljs-subst">${clientKeystorePath}</span>/client.crt`</span>;
<span class="hljs-keyword">if</span> (status === <span class="hljs-string">'all'</span> || status === <span class="hljs-string">'client'</span>) {
    <span class="hljs-comment">// execSync(`${binPath} genrsa -des3 -out ${clientKeyPath} 2048`, execSyncOption);</span>
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> genrsa -out <span class="hljs-subst">${clientKeyPath}</span> 2048`</span>, execSyncOption);
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> req -out <span class="hljs-subst">${clientCsrPath}</span> -key <span class="hljs-subst">${clientKeyPath}</span> -new -config <span class="hljs-subst">${confPath}</span>`</span>, execSyncOption);
    execSync(<span class="hljs-string">`<span class="hljs-subst">${binPath}</span> x509 -req -in <span class="hljs-subst">${clientCsrPath}</span> -CA <span class="hljs-subst">${caCrtPath}</span> -CAkey <span class="hljs-subst">${caKeyPath}</span> -CAcreateserial -out <span class="hljs-subst">${clientCrtPath}</span> -days 1024`</span>, execSyncOption);
}
</code></pre>
<p>최종 적으로 npm script를 작성한다.</p>
<h2 id="packagejsonscript">package.json script</h2>
<p><img src="/static/images/etc/openssl-npm-script.png" alt="npm-script" /></p>
<h2 id="tldr">TL;DR</h2>
<p><code>npm run keygen</code>을 실행하면 CA, Server, Client 순으로 키와 인증서를 생성하기 위한 입력들이 나오고 질문에 맞춰 입력하면 되고, 최종적으로 keystore 폴더 하위에 ca, server, client에 키와 인증서들이 생성된다.</p>
<p>그런 다음, <code>npm start</code>, <code>npm run sub</code>, <code>npm run pub</code>을 실행하여 메시지를 주고 받는 것을 확인해보면 된다.</p>
<p><img src="/static/images/etc/openssl-mqtt-result.png" alt="mqtt-result" /></p>
<p>아래 완성본을 받아서 테스트 해보면 된다.</p>
<h2 id="">완성된 예제</h2>
<p><a href="https://github.com/salgum1114/mqtt-ssl">https://github.com/salgum1114/mqtt-ssl</a></p></div></div><div style="display:flex;align-items:center;margin:64px 0 32px 0"><i aria-label="icon: tags" style="font-size:18px;margin-right:16px" class="anticon anticon-tags"><svg viewBox="64 64 896 896" class="" data-icon="tags" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M483.2 790.3L861.4 412c1.7-1.7 2.5-4 2.3-6.3l-25.5-301.4c-.7-7.8-6.8-13.9-14.6-14.6L522.2 64.3c-2.3-.2-4.7.6-6.3 2.3L137.7 444.8a8.03 8.03 0 0 0 0 11.3l334.2 334.2c3.1 3.2 8.2 3.2 11.3 0zm62.6-651.7l224.6 19 19 224.6L477.5 694 233.9 450.5l311.9-311.9zm60.16 186.23a48 48 0 1 0 67.88-67.89 48 48 0 1 0-67.88 67.89zM889.7 539.8l-39.6-39.5a8.03 8.03 0 0 0-11.3 0l-362 361.3-237.6-237a8.03 8.03 0 0 0-11.3 0l-39.6 39.5a8.03 8.03 0 0 0 0 11.3l243.2 242.8 39.6 39.5c3.1 3.1 8.2 3.1 11.3 0l407.3-406.6c3.1-3.1 3.1-8.2 0-11.3z"></path></svg></i><div><div style="cursor:pointer" class="ant-tag">openssl</div><div style="cursor:pointer" class="ant-tag"> typescript</div><div style="cursor:pointer" class="ant-tag"> mqtt</div></div></div><div style="max-width:100%;overflow:hidden"><ins class=" adsbygoogle" style="display:block" data-ad-client="ca-pub-8569372752842198" data-ad-slot="4568322557" data-ad-layout="" data-ad-format="auto" data-full-width-responsive="true"></ins></div><div class="ant-divider ant-divider-horizontal"></div><div style="margin:32px 0 32px 0"><div style="display:flex;margin:16px 0"><div style="margin-right:16px"><span class="ant-avatar ant-avatar-lg ant-avatar-circle ant-avatar-image"><img src="/static/images/authors/salgum1114.png" alt="Sung Gyun Oh"/></span></div><div><a href="https://github.com/salgum1114" target="_blank"><span style="font-weight:500;color:#212529">Sung Gyun Oh</span></a><div style="word-break:break-word;color:#868e96">Hello world!</div></div></div></div><div class="ant-divider ant-divider-horizontal"></div><div class="ant-spin-nested-loading"><div><div class="ant-spin ant-spin-spinning"><span class="ant-spin-dot ant-spin-dot-spin"><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i></span></div></div><div class="ant-spin-container ant-spin-blur"><div style="height:100%"></div></div></div></div></div></div></div><button type="button" class="ant-btn blog-backtop ant-btn-primary ant-btn-circle"><i aria-label="icon: to-top" style="font-size:1.25rem" class="anticon anticon-to-top"><svg viewBox="64 64 896 896" class="" data-icon="to-top" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M885 780H165c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h720c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8zM400 325.7h73.9V664c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V325.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 171a8 8 0 0 0-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13z"></path></svg></i></button></div></main><div><div class="blog-dialog blog-dialog-right blog-dialog-hide" style="width:0"><div class="blog-dialog-title" style="background-color:#fff;width:100%"><div class="blog-dialog-title-extra"></div><div class="blog-dialog-title-close"><i aria-label="icon: close" tabindex="-1" class="anticon anticon-close"><svg viewBox="64 64 896 896" class="" data-icon="close" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M563.8 512l262.5-312.9c4.4-5.2.7-13.1-6.1-13.1h-79.8c-4.7 0-9.2 2.1-12.3 5.7L511.6 449.8 295.1 191.7c-3-3.6-7.5-5.7-12.3-5.7H203c-6.8 0-10.5 7.9-6.1 13.1L459.4 512 196.9 824.9A7.95 7.95 0 0 0 203 838h79.8c4.7 0 9.2-2.1 12.3-5.7l216.5-258.1 216.5 258.1c3 3.6 7.5 5.7 12.3 5.7h79.8c6.8 0 10.5-7.9 6.1-13.1L563.8 512z"></path></svg></i></div></div><div class="blog-dialog-content" style="padding:0"><div class="blog-search" style="display:flex;flex-direction:column;height:100%"><div style="margin:16px"><span class="ant-input-search ant-input-affix-wrapper"><input type="text" value="" class="ant-input"/><span class="ant-input-suffix"><i aria-label="icon: search" tabindex="-1" class="anticon anticon-search ant-input-search-icon"><svg viewBox="64 64 896 896" class="" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></i></span></span></div><div style="margin:16px"><h4>최근 검색</h4><div style="display:flex;justify-content:center;padding:8px;color:#999999">검색 기록이 없습니다</div></div><div style="margin:16px"><h4>최근 기록</h4><div style="display:flex;justify-content:center;padding:8px;color:#999999">읽은 기록이 없습니다</div></div><div style="margin:16px;flex:1"><h4>전체 태그</h4><div style="margin:8px;cursor:pointer" class="ant-tag">react (6)</div><div style="margin:8px;cursor:pointer" class="ant-tag">nextjs (3)</div><div style="margin:8px;cursor:pointer" class="ant-tag">website (3)</div><div style="margin:8px;cursor:pointer" class="ant-tag">openssl (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">typescript (2)</div><div style="margin:8px;cursor:pointer" class="ant-tag">mqtt (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">medium-zoom (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">css (2)</div><div style="margin:8px;cursor:pointer" class="ant-tag">overscroll-behavior (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">scroll-behavior (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">component (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">backtop (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">webpack (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">uglifyjs (1)</div><div style="margin:8px;cursor:pointer" class="ant-tag">terser-webpack-plugin (1)</div></div></div></div><div class="blog-dialog-footer" style="justify-content:center"><a href="https://github.com/salgum1114" target="_blank"><i aria-label="icon: github" style="font-size:1.25rem" class="anticon anticon-github"><svg viewBox="64 64 896 896" class="" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></div></div></div></section></div><script>__NEXT_DATA__ = {"props":{"pageProps":{"post":{"path":"/etc/2019-05-20-using-openssl-in-windows","content":"\u003cp\u003e회사에서 MQTT를 SSL/TLS로 테스트해야 하는 경우가 생겼는데, 기존에 나와있는 \u003ca href=\"https://mosquitto.org/\"\u003eEclipse Mosquitto\u003c/a\u003e로 하려다가 이왕 하는 김에 Javascrpt로 MQTT Broker랑 Client (Pub, Sub)를 직접 구현해보기로 했다.\u003c/p\u003e\n\u003cp\u003e전체적으로 MQTT Broker와 Client를 구현하기 위한 라이브러리들은 다음과 같다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/mcollina/mosca\"\u003eMosca\u003c/a\u003e (MQTT Broker) \u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/mqttjs/MQTT.js\"\u003eMQTT.js\u003c/a\u003e (MQTT Client)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e두개의 라이브러리를 받고 예제를 각 라이브러리들의 github에서 사용법을 찾아보면 된다.\u003c/p\u003e\n\u003ch2 id=\"moscaserverts\"\u003eMosca 예제 (server.ts)\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e mosca \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'mosca'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { moscaSettings } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./options'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e server = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e mosca.Server(moscaSettings, () =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(\u003cspan class=\"hljs-string\"\u003e'Mosca server is up and running'\u003c/span\u003e);\n});\n\nserver.on(\u003cspan class=\"hljs-string\"\u003e'clientConnected'\u003c/span\u003e, (client: mosca.Client) =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(\u003cspan class=\"hljs-string\"\u003e'Client connected'\u003c/span\u003e, client.id, \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eDate\u003c/span\u003e());\n});\n\nserver.on(\u003cspan class=\"hljs-string\"\u003e'clientDisconnected'\u003c/span\u003e, (client: mosca.Client) =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(\u003cspan class=\"hljs-string\"\u003e'Client Disconnected:'\u003c/span\u003e, client.id, \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eDate\u003c/span\u003e());\n});\n\nserver.on(\u003cspan class=\"hljs-string\"\u003e'published'\u003c/span\u003e, (packet: mosca.Packet, client?: mosca.Client, callback?: \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e) =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(\u003cspan class=\"hljs-string\"\u003e'Published'\u003c/span\u003e, packet.payload, client \u0026amp;\u0026amp; client.id, callback);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"mqttjspublisherts\"\u003eMQTT.js 예제 (publisher.ts)\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e mqtt \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'mqtt'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { mqttClientOptions, mqttsClientOptions } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./options'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e client = mqtt.connect(mqttsClientOptions);\n\nclient.on(\u003cspan class=\"hljs-string\"\u003e'connect'\u003c/span\u003e, () =\u0026gt; {\n    client.subscribe(\u003cspan class=\"hljs-string\"\u003e'presence'\u003c/span\u003e);\n    client.publish(\u003cspan class=\"hljs-string\"\u003e'presence'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Hello mqtt'\u003c/span\u003e);\n    client.end();\n});\n\nclient.on(\u003cspan class=\"hljs-string\"\u003e'error'\u003c/span\u003e, (error) =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(error);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"mqttjssubsriberts\"\u003eMQTT.js 예제 (subsriber.ts)\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e mqtt \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'mqtt'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { mqttClientOptions, mqttsClientOptions } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./options'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e client = mqtt.connect(mqttsClientOptions);\n\nclient.on(\u003cspan class=\"hljs-string\"\u003e'connect'\u003c/span\u003e, () =\u0026gt; {\n    client.subscribe(\u003cspan class=\"hljs-string\"\u003e'presence'\u003c/span\u003e);\n});\n\nclient.on(\u003cspan class=\"hljs-string\"\u003e'message'\u003c/span\u003e, (topic, message) =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(topic, message);\n    client.end();\n});\n\nclient.on(\u003cspan class=\"hljs-string\"\u003e'error'\u003c/span\u003e, (error) =\u0026gt; {\n    \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(error);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"optionsts\"\u003e옵션 (options.ts)\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { IClientOptions } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'mqtt'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e fs \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'fs'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e interface ClientOptions extends IClientOptions {\n    passphrase?: string;\n    secureProtocol?: string;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e interface MoscaLogger {\n    name?: string;\n    level?: number | string;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e interface MoscaSecure {\n    port?: number;\n    keyPath?: string;\n    certPath?: string;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e interface MoscaSettings {\n    \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: number;\n    logger?: MoscaLogger;\n    secure?: MoscaSecure;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mqttClientOptions: ClientOptions = {\n    \u003cspan class=\"hljs-attr\"\u003ehost\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'localhost'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1883\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprotocol\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'mqtt'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003econnectTimeout\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e,\n};\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mqttsClientOptions: ClientOptions = {\n    \u003cspan class=\"hljs-attr\"\u003ehost\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'localhost'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e8443\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprotocol\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'mqtts'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprotocolId\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'MQIsdp'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprotocolVersion\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003esecureProtocol\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'TLSv1_method'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003ereconnectPeriod\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003erejectUnauthorized\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003econnectTimeout\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eca\u003c/span\u003e: [fs.readFileSync(\u003cspan class=\"hljs-string\"\u003e'keystore/ca/ca.crt'\u003c/span\u003e)],\n    \u003cspan class=\"hljs-attr\"\u003ekey\u003c/span\u003e: fs.readFileSync(\u003cspan class=\"hljs-string\"\u003e'keystore/client/client.key'\u003c/span\u003e),\n    \u003cspan class=\"hljs-attr\"\u003ecert\u003c/span\u003e: fs.readFileSync(\u003cspan class=\"hljs-string\"\u003e'keystore/client/client.crt'\u003c/span\u003e),\n};\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e moscaSettings: MoscaSettings = {\n    \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1883\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003elogger\u003c/span\u003e: {\n        \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"secure\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003elevel\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e40\u003c/span\u003e,\n    },\n    \u003cspan class=\"hljs-attr\"\u003esecure\u003c/span\u003e: {\n        \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e8443\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003ekeyPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'keystore/server/server.key'\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003ecertPath\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'keystore/server/server.crt'\u003c/span\u003e,\n    },\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이제 문제는 Openssl 인데, Windows에서 Openssl을 사용하기 위해 2가지 방법이 있다.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e바이너리로 묵인 것을 다운로드 받기.\u003c/li\u003e\n\u003cli\u003e소스를 받아서 직접 빌드하기.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e2번은 귀찮기 때문에, 1번을 찾아보고 다운로드 받았다.\u003c/p\u003e\n\u003cblockquote\u003e\n  \u003cp\u003e\u003ca href=\"https://code.google.com/archive/p/openssl-for-windows/downloads\"\u003ehttps://code.google.com/archive/p/openssl-for-windows/downloads\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e다운로드 받고나면 압축을 푼 경로로 들어가 \u003ccode\u003ebin\u003c/code\u003e에서 \u003ccode\u003eWindows Command Line\u003c/code\u003e으로 직접 \u003ccode\u003eopenssl\u003c/code\u003e명령어를 치면 되지만, 매번 할 수 없기 때문에 이것도 javascript로 \u003ccode\u003ekeygen\u003c/code\u003e을 만들었다.\u003c/p\u003e\n\u003cp\u003e프로젝트 경로로 맞춰 명령어를 실행하기 위해 openssl을 압축을 풀어 프로젝트 내부로 옮기고, 마찬가지로 openssl로 생성된 키와 인증서를 프로젝트 내부에 두기 위해 프로젝트 내에 \u003ccode\u003ekeystore\u003c/code\u003e 폴더를 만든다.\u003c/p\u003e\n\u003cblockquote\u003e\n  \u003cp\u003eOpenssl로 생성해야되는 키와 인증서는 자체 서명된 CA, Server, Client가 모두 필요하기 때문에 keystore 하위 폴더로 ca, server, client를 만든다.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e위에 작성된 MQTT Broker, Client, Options를 포함하여 이렇게 생긴 폴더 구조가 생길 것이다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static/images/etc/openssl-project-directory.png\" alt=\"project-directory\" /\u003e\u003c/p\u003e\n\u003cp\u003e그 다음 openssl 명령어를 실행하기 위한 Keygen을 작성한다.\u003c/p\u003e\n\u003ch2 id=\"keygenkeygents\"\u003eKeygen (keygen.ts)\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs javascript language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { execSync, ExecSyncOptions } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'child_process'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e path \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'path'\u003c/span\u003e;\n\ntype Status = \u003cspan class=\"hljs-string\"\u003e'all'\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e'ca'\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e'server'\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e'client'\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e'verify'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e argsLength = process.argv.length;\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e status: Status = \u003cspan class=\"hljs-string\"\u003e'all'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (argsLength \u0026gt; \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e) {\n    status = process.argv.slice(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e] \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e Status;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e opensslPath = \u003cspan class=\"hljs-string\"\u003e'openssl/bin/openssl'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e opensslConfPath = \u003cspan class=\"hljs-string\"\u003e`openssl/openssl.cnf`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e binPath = path.resolve(__dirname, opensslPath)\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e confPath = path.resolve(__dirname, opensslConfPath);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e execSyncOption: ExecSyncOptions = {\n    \u003cspan class=\"hljs-attr\"\u003estdio\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'inherit'\u003c/span\u003e,\n}\n\n\u003cspan class=\"hljs-comment\"\u003e/**\n * Create CA\n */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e caKeystorePath = \u003cspan class=\"hljs-string\"\u003e'keystore/ca'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e caKeyPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${caKeystorePath}\u003c/span\u003e/ca.key`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e caCrtPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${caKeystorePath}\u003c/span\u003e/ca.crt`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (status === \u003cspan class=\"hljs-string\"\u003e'all'\u003c/span\u003e || status === \u003cspan class=\"hljs-string\"\u003e'ca'\u003c/span\u003e) {\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e req -new -x509 -days 1024 -extensions v3_ca -keyout \u003cspan class=\"hljs-subst\"\u003e${caKeyPath}\u003c/span\u003e -out \u003cspan class=\"hljs-subst\"\u003e${caCrtPath}\u003c/span\u003e -config \u003cspan class=\"hljs-subst\"\u003e${confPath}\u003c/span\u003e`\u003c/span\u003e, execSyncOption);\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (status === \u003cspan class=\"hljs-string\"\u003e'verify'\u003c/span\u003e) {\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e x509 -text -in \u003cspan class=\"hljs-subst\"\u003e${caCrtPath}\u003c/span\u003e`\u003c/span\u003e, execSyncOption)   ;\n}\n\n\u003cspan class=\"hljs-comment\"\u003e/**\n * Create server key\n */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e serverKeystorePath = \u003cspan class=\"hljs-string\"\u003e'keystore/server'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e serverKeyPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${serverKeystorePath}\u003c/span\u003e/server.key`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e serverCsrPath =  \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${serverKeystorePath}\u003c/span\u003e/server.csr`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e serverCrtPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${serverKeystorePath}\u003c/span\u003e/server.crt`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (status === \u003cspan class=\"hljs-string\"\u003e'all'\u003c/span\u003e || status === \u003cspan class=\"hljs-string\"\u003e'server'\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// execSync(`${binPath} genrsa -des3 -out ${serverKeyPath} 2048`, execSyncOption);\u003c/span\u003e\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e genrsa -out \u003cspan class=\"hljs-subst\"\u003e${serverKeyPath}\u003c/span\u003e 2048`\u003c/span\u003e, execSyncOption);\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e req -out \u003cspan class=\"hljs-subst\"\u003e${serverCsrPath}\u003c/span\u003e -key \u003cspan class=\"hljs-subst\"\u003e${serverKeyPath}\u003c/span\u003e -new -config \u003cspan class=\"hljs-subst\"\u003e${confPath}\u003c/span\u003e`\u003c/span\u003e, execSyncOption);\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e x509 -req -in \u003cspan class=\"hljs-subst\"\u003e${serverCsrPath}\u003c/span\u003e -CA \u003cspan class=\"hljs-subst\"\u003e${caCrtPath}\u003c/span\u003e -CAkey \u003cspan class=\"hljs-subst\"\u003e${caKeyPath}\u003c/span\u003e -CAcreateserial -out \u003cspan class=\"hljs-subst\"\u003e${serverCrtPath}\u003c/span\u003e -days 1024`\u003c/span\u003e, execSyncOption);\n}\n\n\u003cspan class=\"hljs-comment\"\u003e/**\n * Create client key\n */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientKeystorePath = \u003cspan class=\"hljs-string\"\u003e'keystore/client'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientKeyPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${clientKeystorePath}\u003c/span\u003e/client.key`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientCsrPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${clientKeystorePath}\u003c/span\u003e/client.csr`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientCrtPath = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${clientKeystorePath}\u003c/span\u003e/client.crt`\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (status === \u003cspan class=\"hljs-string\"\u003e'all'\u003c/span\u003e || status === \u003cspan class=\"hljs-string\"\u003e'client'\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// execSync(`${binPath} genrsa -des3 -out ${clientKeyPath} 2048`, execSyncOption);\u003c/span\u003e\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e genrsa -out \u003cspan class=\"hljs-subst\"\u003e${clientKeyPath}\u003c/span\u003e 2048`\u003c/span\u003e, execSyncOption);\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e req -out \u003cspan class=\"hljs-subst\"\u003e${clientCsrPath}\u003c/span\u003e -key \u003cspan class=\"hljs-subst\"\u003e${clientKeyPath}\u003c/span\u003e -new -config \u003cspan class=\"hljs-subst\"\u003e${confPath}\u003c/span\u003e`\u003c/span\u003e, execSyncOption);\n    execSync(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${binPath}\u003c/span\u003e x509 -req -in \u003cspan class=\"hljs-subst\"\u003e${clientCsrPath}\u003c/span\u003e -CA \u003cspan class=\"hljs-subst\"\u003e${caCrtPath}\u003c/span\u003e -CAkey \u003cspan class=\"hljs-subst\"\u003e${caKeyPath}\u003c/span\u003e -CAcreateserial -out \u003cspan class=\"hljs-subst\"\u003e${clientCrtPath}\u003c/span\u003e -days 1024`\u003c/span\u003e, execSyncOption);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e최종 적으로 npm script를 작성한다.\u003c/p\u003e\n\u003ch2 id=\"packagejsonscript\"\u003epackage.json script\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"/static/images/etc/openssl-npm-script.png\" alt=\"npm-script\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"tldr\"\u003eTL;DR\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003enpm run keygen\u003c/code\u003e을 실행하면 CA, Server, Client 순으로 키와 인증서를 생성하기 위한 입력들이 나오고 질문에 맞춰 입력하면 되고, 최종적으로 keystore 폴더 하위에 ca, server, client에 키와 인증서들이 생성된다.\u003c/p\u003e\n\u003cp\u003e그런 다음, \u003ccode\u003enpm start\u003c/code\u003e, \u003ccode\u003enpm run sub\u003c/code\u003e, \u003ccode\u003enpm run pub\u003c/code\u003e을 실행하여 메시지를 주고 받는 것을 확인해보면 된다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/static/images/etc/openssl-mqtt-result.png\" alt=\"mqtt-result\" /\u003e\u003c/p\u003e\n\u003cp\u003e아래 완성본을 받아서 테스트 해보면 된다.\u003c/p\u003e\n\u003ch2 id=\"\"\u003e완성된 예제\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/salgum1114/mqtt-ssl\"\u003ehttps://github.com/salgum1114/mqtt-ssl\u003c/a\u003e\u003c/p\u003e","preview":"회사에서 MQTT를 SSL/TLS로 테스트해야 하는 경우가 생겼는데, 기존에 나와있는 Eclipse Mosquitto로 하려다가 이왕 하는 김에\nJavascrpt로 MQTT Broker랑 Client (Pub, Sub)를 직접 구현해보기로 했다.\n\n전체적으로 MQTT Broker와 Client를 구현하기 위한 라이브러리들은 다음과 같다.\n\n * Mosca ...","title":"Windows에서 openssl로 인증서 생성하고 MQTT로 테스트하기","author":"salgum1114","date":"2019-05-20 10:09","tags":"openssl, typescript, mqtt","cover":"/static/images/covers/openssl.png","next":"/reactjs/2019-05-11-using-typescript-without-tsx","prev":"/nextjs/2019-05-20-nextjs-static-website-2"}},"authors":{"salgum1114":{"name":"salgum1114","title":"Sung Gyun Oh","avatar":"/static/images/authors/salgum1114.png","bio":"Hello world!"}},"tags":{"react":{"total":6,"paths":["/nextjs/2019-05-21-nextjs-static-website-3","/nextjs/2019-05-20-nextjs-static-website-2","/reactjs/2019-05-11-using-typescript-without-tsx","/nextjs/2019-05-06-nextjs-static-website-1","/reactjs/2019-05-03-medium-zoom","/reactjs/2019-04-25-back-top-component"]},"nextjs":{"total":3,"paths":["/nextjs/2019-05-21-nextjs-static-website-3","/nextjs/2019-05-20-nextjs-static-website-2","/nextjs/2019-05-06-nextjs-static-website-1"]},"website":{"total":3,"paths":["/nextjs/2019-05-21-nextjs-static-website-3","/nextjs/2019-05-20-nextjs-static-website-2","/nextjs/2019-05-06-nextjs-static-website-1"]},"openssl":{"total":1,"paths":["/etc/2019-05-20-using-openssl-in-windows"]},"typescript":{"total":2,"paths":["/etc/2019-05-20-using-openssl-in-windows","/reactjs/2019-05-11-using-typescript-without-tsx"]},"mqtt":{"total":1,"paths":["/etc/2019-05-20-using-openssl-in-windows"]},"medium-zoom":{"total":1,"paths":["/reactjs/2019-05-03-medium-zoom"]},"css":{"total":2,"paths":["/css/2019-04-30-overscroll-behavior-contain","/css/2019-04-28-scroll-behavior-smooth"]},"overscroll-behavior":{"total":1,"paths":["/css/2019-04-30-overscroll-behavior-contain"]},"scroll-behavior":{"total":1,"paths":["/css/2019-04-28-scroll-behavior-smooth"]},"component":{"total":1,"paths":["/reactjs/2019-04-25-back-top-component"]},"backtop":{"total":1,"paths":["/reactjs/2019-04-25-back-top-component"]},"webpack":{"total":1,"paths":["/webpack/2019-04-22-uglifyjs-to-terser"]},"uglifyjs":{"total":1,"paths":["/webpack/2019-04-22-uglifyjs-to-terser"]},"terser-webpack-plugin":{"total":1,"paths":["/webpack/2019-04-22-uglifyjs-to-terser"]}}},"page":"/post","query":{"slug":"/etc/2019-05-20-using-openssl-in-windows"},"buildId":"U5IhnviFqTk~~epRaNeLM","nextExport":true};__NEXT_LOADED_PAGES__=[];__NEXT_REGISTER_PAGE=function(r,f){__NEXT_LOADED_PAGES__.push([r, f])}</script><script async="" id="__NEXT_PAGE__/post" src="/_next/static/U5IhnviFqTk~~epRaNeLM/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/U5IhnviFqTk~~epRaNeLM/pages/_app.js"></script><script async="" id="__NEXT_PAGE__/_error" src="/_next/static/U5IhnviFqTk~~epRaNeLM/pages/_error.js"></script><script src="/_next/static/runtime/webpack-23e8ad5be623829fec40.js" async=""></script><script src="/_next/static/chunks/commons.e3402e7f824d0aba2cfe.js" async=""></script><script src="/_next/static/chunks/styles.7ace514dc30ea1c400cd.js" async=""></script><script src="/_next/static/runtime/main-8874558eaa942f1ad073.js" async=""></script></body></html>